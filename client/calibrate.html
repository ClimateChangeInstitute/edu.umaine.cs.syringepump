<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<meta name="description"
	content="Syringe pump controller using linear-actuator">
<meta name="author" content="Mark Royer">
<link rel="icon" href="../../favicon.ico">

<title>Syringe Pump Controller</title>

<!-- Bootstrap core CSS -->
<link href="lib/bootstrap-3.3.6-dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="lib/bootstrap-3.3.6-dist/css/bootstrap-theme.min.css"
	rel="stylesheet">
<link href="lib/font-awesome-4.6.3/css/font-awesome.css"
	rel="stylesheet">

<link href="site.css" rel="stylesheet">





</head>
<body>
	<div id="header">
		<!-- Navigation will be populated here from header.html -->
	</div>

	<div class="container" style="padding-top: 15px">
		<div class="form-group">
			<div class="row">
				<label for="syringeStatus"
					class="col-xs-12 col-sm-3 form-control-label">Syringe
					Status</label>
				<div class="col-xs-12 col-sm-9">
					<div id="syringeStatus" class="alert alert-info">The syringe
						is not active.</div>
				</div>
			</div>
			<div class="row">
				<label for="syringeProgress"
					class="col-xs-12 col-sm-3 form-control-label">Progress
					(steps)</label>
				<div class="col-xs-12 col-sm-9">
					<div class="progress">
						<div id="syringeProgress"
							class="progress-bar progress-bar-info progress-bar-striped"
							role="progressbar" aria-valuenow="0" aria-valuemin="0"
							aria-valuemax="100" style="width: 0%">0 (0%)</div>
					</div>
				</div>
			</div>
		</div>
		<div id="rootwizard" class="tabbable">
			<ul>
				<li id="l1k"><a href="#tab1" data-toggle="tab">1: Load 1k</a></li>
				<li id="l2k"><a href="#tab2" data-toggle="tab">2: Load 2k</a></li>
				<li id="l4k"><a href="#tab3" data-toggle="tab">3: Load 4k</a></li>
				<li id="saveTab"><a href="#tab4" data-toggle="tab">4:
						Verify &amp; Save</a></li>
			</ul>
			<div class="tab-content">
				<div class="tab-pane" id="tab1">
					<!-- Contents from calibrateStep.html and ready function -->
				</div>
				<div class="tab-pane" id="tab2">
					<!-- Contents from calibrateStep.html and ready function -->
				</div>
				<div class="tab-pane" id="tab3">
					<!-- Contents from calibrateStep.html and ready function -->
				</div>
				<div class="tab-pane" id="tab4">
					<div class="form-group">
						<div class="row">
							<label for="input1kFinal"
								class="col-xs-12 col-sm-6 form-control-label">1000 steps
								ml</label>
							<div class="col-xs-12 col-sm-6">
								<input id="input1kFinal" type="number" class="form-control"
									min="0">
							</div>
						</div>
						<div class="row">
							<label for="input2kFinal"
								class="col-xs-12 col-sm-6 form-control-label">2000 steps
								ml</label>
							<div class="col-xs-12 col-sm-6">
								<input id="input2kFinal" type="number" class="form-control"
									min="0">
							</div>
						</div>
						<div class="row">
							<label for="input4kFinal"
								class="col-xs-12 col-sm-6 form-control-label">4000 steps
								ml</label>
							<div class="col-xs-12 col-sm-6">
								<input id="input4kFinal" type="number" class="form-control"
									min="0">
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12 col-sm-6">
								<p>Please verify the inputs shown above. If they are
									correct, click save.</p>
							</div>
						</div>
					</div>
				</div>
				<ul class="pager wizard">
					<li class="previous"><a href="#">Previous</a></li>
					<li class="next"><a href="#">Next</a></li>
					<li class="next finish" style="display: none;"><a
						href="javascript:;">Save</a></li>
				</ul>
			</div>
		</div>

	</div>


	<div id="modals">
		<!-- Modal dialogs will be populated here from modals.html -->
	</div>

	<!-- Bootstrap core JavaScript
    ================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script>
		window.jQuery
				|| document
						.write('<script type="text\/javascript" src="lib/jquery/jquery-2.2.4.min.js"><\/script>')
	</script>
	<script type="text/javascript"
		src="lib/bootstrap-3.3.6-dist/js/bootstrap.js"></script>
	<script type="text/javascript"
		src="lib/twitter-bootstrap-wizard/jquery.bootstrap.wizard.js"></script>

	<script type="text/javascript" src="js/syringepump.js"></script>
	<script type="text/javascript">
		$(document)
				.ready(
						function() {
							$("#header").load("header.html", function() {
								$("#calNav").addClass("active");
							});
							$("#modals").load("modals.html");
							$('#rootwizard')
									.bootstrapWizard(
											{
												'tabClass' : 'nav nav-tabs',
												'onNext' : function(evt) {
													// Do nothing...
												},
												'onLast' : function(evt) {
													// Do nothing...
												},
												'onTabShow' : function(tab,
														navigation, index) {
													var $total = navigation
															.find('li').length;
													var $current = index + 1;
													var $percent = ($current / $total) * 100;
													$('#rootwizard').find(
															'.bar').css({
														width : $percent + '%'
													});

													// If it's the last tab then hide the next button and show the save instead
													if ($current >= $total) {
														$('#rootwizard').find(
																'.pager .next')
																.hide();
														$('#rootwizard')
																.find(
																		'.pager .finish')
																.show();
														$('#rootwizard')
																.find(
																		'.pager .finish')
																.removeClass(
																		'disabled');

														// Make sure final values match
														$('#input1kFinal').val(
																$('#input1k')
																		.val());
														$('#input2kFinal').val(
																$('#input2k')
																		.val());
														$('#input4kFinal').val(
																$('#input4k')
																		.val());

													} else {
														$('#rootwizard').find(
																'.pager .next')
																.show();
														$('#rootwizard')
																.find(
																		'.pager .finish')
																.hide();
													}
												}
											});
							$('#rootwizard .finish').click(
									function() {
										
										var v1 = parseFloat($('#input1kFinal').val());
										var v2 = parseFloat($('#input2kFinal').val());
										var v3 = parseFloat($('#input4kFinal').val());
										
										// *************************************************
										// START calculate linear regression of three values
										// *************************************************

										var xMean = (1000 + 2000 + 4000) / 3.0;
										var yMean = (v1 + v2 + v3) / 3.0;
										
										var mTop = (1000-xMean)*(v1-yMean)+(2000-xMean)*(v2-yMean)+(4000-xMean)*(v3-yMean);
										var mBottom = (1000-xMean)*(1000-xMean)+(2000-xMean)*(2000-xMean)+(4000-xMean)*(4000-xMean);
										var m = mTop / mBottom; // ml per step
										var b = yMean - m * xMean;

										// *************************************************
										// END calculate linear regression of three values
										// *************************************************
										
										
										// Values that need to be retrieved
										
										// Get default values and ask for update confirmation
										$.getJSON("settings.json", function(data) {
											var defaultLoadAmnt_ml = data.defaultLoadAmount_ml;
											var defaultUnloadTime_min = data.defaultUnloadTime_min;
											var defaultLoadTime_sec = data.defaultLoadTime_sec;
											
											var currentDiameter = data.defaultSyringeDiameter_mm;
											var stepsPerRev = data.defaultStepsPerRevolution;
											var currentPitch = data.defaultPitch_mmPerRev;
											
											// 1000 cubic mm per 1 ml
											var mm3PerMl = 1000;
											var r = currentDiameter / 2.0;
											
											// Calculate the new values
											
											var newPitch = m * mm3PerMl / (3.14159 * r * r) * stepsPerRev;
											var newDiameter = 2 * Math.sqrt(m*mm3PerMl*stepsPerRev / (3.14159 * currentPitch));
											
											
											console.log("New pitch = " + newPitch);
											console.log("New diameter = " + newDiameter);
										});
										
									});

							// Initialize the load and unload button click events

							var initLoadAndUnloadEvents = function(buttonName,
									loadSteps, isLoad) {
								$('#' + buttonName)
										.click(
												function(event) {

													$('#' + buttonName).attr(
															'data-steps',
															loadSteps);

													console
															.log("Number of steps "
																	+ loadSteps);

													// time should be in milliseconds
													$
															.ajax({
																method : "POST",
																url : "moveSteps",
																data : {
																	steps : loadSteps,
																	time_ms : Math
																			.abs(loadSteps * 5)
																},
																success : function(
																		data) {

																	var result = $
																			.parseJSON(data);

																	sp
																			.displayMessage(
																					'Syringe pump started to load. Sit back and relax...',
																					'info');

																	var min = result.start;
																	var max = result.end;
																	if (result.end < result.start) {
																		min = result.end;
																		max = result.start;
																	}

																	console
																			.log(min
																					+ " "
																					+ max);

																	sp
																			.checkLevels(
																					300,
																					min,
																					max,
																					isLoad,
																					"steps");

																},
																error : function(
																		msg) {
																	console
																			.log('Failed to start!');
																}
															});

												});

							}

							var tabInit = function(tabName, loadName,
									loadSteps, unloadName, unloadSteps, inputId) {
								$('#' + tabName).load(
										"calibrateStep.html",
										function() {
											var buttons = $(this)
													.find('button');
											var stepLoad = $(buttons[0]);
											stepLoad.attr('id', loadName);
											var stepUnload = $(buttons[1]);
											stepUnload.attr('id', unloadName);
											initLoadAndUnloadEvents(loadName,
													loadSteps, true);
											initLoadAndUnloadEvents(unloadName,
													unloadSteps, false);
											// Update text elemnts
											$(this).find('.loadSteps').text(
													loadSteps);
											// Update input ID
											$(this).find('#inputNumber').attr(
													'id', inputId);
										});
							};

							tabInit("tab1", "step1000Button", 1000,
									"step-1000Button", -1000, "input1k");
							tabInit("tab2", "step2000Button", 2000,
									"step-2000Button", -2000, "input2k");
							tabInit("tab3", "step4000Button", 4000,
									"step-4000Button", -4000, "input4k");

						});
	</script>
</body>

</html>